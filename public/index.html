<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Words — тренажёр</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; line-height: 1.4; max-width: 820px; margin: 24px auto; padding: 0 16px; }
    h1,h2 { margin: 16px 0 8px; }
    table { border-collapse: collapse; width: 100%; margin-top: 8px; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; }
    #feedback { font-weight: 600; margin: 8px 0 4px; }
    #interval { color: #666; margin: 0 0 8px; }
    input[type="text"]{ padding: 6px 8px; }
    button{ padding: 6px 10px; cursor:pointer; }
  </style>
</head>
<body>

  <h1>Добавить слово</h1>
  <form id="addForm">
    <input type="text" name="de" placeholder="Немецкое слово" required />
    <input type="text" name="ru" placeholder="Перевод" required />
    <button type="submit">Добавить</button>
  </form>

<p>
  <label>
    <input type="checkbox" id="fastMode">
    Fast mode ×30
  </label>
</p>


  <h1>Тренировка</h1>
  <div id="train">
    <p id="question">Нажми «Начать тренировку»</p>
    <input id="answer" placeholder="Перевод" style="display:none;" />
    <p id="feedback"></p>
    <p id="interval"></p>
    <button id="start">Начать тренировку</button>
  </div>

  <hr />

  <h1>Текущие слова</h1>
  <table>
    <thead>
      <tr>
        <th>DE</th><th>RU</th><th>DE→RU</th><th>RU→DE</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
  <p><button id="reset">Сбросить статистику</button></p>

  <script>
    // ---------- helpers ----------
    const DEBUG = true;
    const log = (...a) => DEBUG && console.debug('[WORDS]', ...a);
    let mode = 'idle'; // 'ask' | 'check' | 'next'
    let pauseTimer = null;
    let intervalsHours = [];
    fetch('/api/intervals').then(r=>r.json()).then(arr => intervalsHours = arr);

    function humanInterval(i){
      const h = intervalsHours[i] ?? 0;
      const factor = isFast() ? 1/60 : 1;
      const adjH = h * factor;
      if (adjH < 1)  return `${Math.round(adjH*60)} мин`;
      if (adjH < 24) return `${adjH} ч`;
      return `${Math.round(adjH/24)} дн`;
    }

    // ---------- state ----------
    let words = [];
    let current, reverse;

    // ---------- data fetchers ----------
    async function loadWords(){
      const r = await fetch('/api/words');
      words = await r.json();
    }

    async function updateTable(){
      const r = await fetch('/api/words');
      const data = await r.json();
      words = data; // синхронизируем кэш
      const body = document.getElementById('tableBody');
      body.innerHTML = '';
      data.forEach(w => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${w.de}</td>
          <td>${w.ru}</td>
          <td>${w.interval_de_ru} (${humanInterval(w.interval_de_ru)})</td>
          <td>${w.interval_ru_de} (${humanInterval(w.interval_ru_de)})</td>
        `;
        body.appendChild(row);
      });
    }

    // ---------- add word form ----------
    document.getElementById('addForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const f = e.target;
      const body = { de: f.de.value.trim(), ru: f.ru.value.trim() };
      if (!body.de || !body.ru) return;
      await fetch('/api/add_word', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      f.reset();
      await updateTable();
    });

    // ---------- training ----------
    const q = document.getElementById('question');
    const a = document.getElementById('answer');
    const startBtn = document.getElementById('start');
    const feedback = document.getElementById('feedback');
    const intElem = document.getElementById('interval');

    function pickWord(){
      log('pick:start');
      if (pauseTimer){ clearInterval(pauseTimer); pauseTimer = null; }
      startBtn.style.display = "inline";
      const now = new Date();
      const cards = [];
      for (const w of words){
        if (new Date(w.next_de_ru) < now) cards.push({ w, reverse:false }); // DE→RU
        if (new Date(w.next_ru_de) < now) cards.push({ w, reverse:true  }); // RU→DE
      }
      log('pick:cards', cards.length);

      if (!cards.length){
        const nextTimes = words
          .map(w => Math.min(new Date(w.next_de_ru), new Date(w.next_ru_de)))
          .filter(t => t > new Date())
          .sort((a,b)=>a-b);
        const next = nextTimes[0];
        log('pick:pause', { hasNext: !!next, next });
        if (!next){
          q.textContent = "Все слова на паузе. Ожидание новых слов…";
          a.style.display = "none";
          startBtn.style.display = "none";
          return;
        }

        function tick(){
          const diff = next - new Date();
          if (diff <= 0){
            log('tick:zero -> autostart');
            clearInterval(pauseTimer); pauseTimer = null;
            q.textContent = "Время истекло, загружаем слова...";
            startBtn.textContent = 'Следующее слово'; // сброс кнопки
            loadWords().then(()=>controller());
            return;
          }
          const m = Math.floor(diff/60000);
          const s = Math.floor(diff/1000) % 60;
          q.textContent = `Все слова на паузе. Следующее слово через ${m} мин ${s} сек.`;
        }
        tick();
        pauseTimer = setInterval(tick, 1000);

        a.style.display = "none";
        startBtn.style.display = "none";
        return;
      }

      const pick = cards[Math.floor(Math.random()*cards.length)];
      current = pick.w;
      reverse = pick.reverse;
      log('pick:show', { id: current.id, word: current.de, reverse });

      q.textContent = reverse ? `Переведи: ${current.ru}` : `Переведи: ${current.de}`;
      a.style.display = "inline";
      a.value = "";
      a.focus();
    }

    async function processAnswer(){
      const user = a.value.trim().toLowerCase();
      const correct = reverse ? user === current.de.toLowerCase()
                              : user === current.ru.toLowerCase();
      log('answer', { id: current.id, reverse, user, correct });

      feedback.textContent = correct
        ? `✅ Верно: ${reverse ? current.ru : current.de} — ${reverse ? current.de : current.ru}`
        : `❌ Ошибка: ${reverse ? current.ru : current.de} — ${reverse ? current.de : current.ru}`;
      feedback.style.color = correct ? 'green' : 'red';

      startBtn.disabled = true;

      const resp = await fetch(`/api/result?fast=${isFast() ? 1 : 0}`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ id: current.id, correct, reverse })
      });
      const data = await resp.json();
      const w = data.updated;

      const key = reverse ? 'interval_ru_de' : 'interval_de_ru';
      const h = intervalsHours[w[key]];
      const text = (h < 1) ? `${Math.round(h*60)} минут`
                 : (h < 24) ? `${h} часов`
                 : `${Math.round(h/24)} дней`;
      intElem.textContent = `Следующая встреча этого слова через ${text}.`;

      await updateTable();
      log('answer:updated');

      startBtn.disabled = false;
      startBtn.textContent = 'Следующее слово';
    }

    async function controller(){
      log('controller', { mode, btn: startBtn.textContent, words: words.length });
      if (!words.length) await loadWords();

      if (startBtn.textContent === 'Начать тренировку' || startBtn.textContent === 'Следующее слово'){
        startBtn.textContent = 'Проверить';
        feedback.textContent = '';
        intElem.textContent = '';
        pickWord();
        return;
      }

      if (startBtn.textContent === 'Проверить'){
        await processAnswer();
        return;
      }
    }

    startBtn.addEventListener('click', controller);

    // Enter = клик по кнопке, но только если не ждём сервер
    a.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !startBtn.disabled){
        e.preventDefault();
        controller();
      }
    });

    // ---------- reset ----------
    document.getElementById('reset').addEventListener('click', async ()=>{
      if (!confirm('Сбросить всю статистику?')) return;
      await fetch('/api/reset', { method: 'POST' });
      feedback.textContent = '';
      intElem.textContent = '';
      await updateTable();
    });

    // ---------- fast mode ----------
    const fastBox = document.getElementById('fastMode');
    fastBox.checked = localStorage.getItem('fastMode') === 'true';
    fastBox.addEventListener('change', () => {
      localStorage.setItem('fastMode', fastBox.checked);
      log('Fast mode:', fastBox.checked);
    });
    function isFast(){ return fastBox.checked; }

    // первый рендер таблицы/списка
    updateTable();
    loadWords().then(() => controller());
  </script>
</body>
</html>
