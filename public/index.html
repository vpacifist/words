<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Words — тренажёр</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; line-height: 1.4; max-width: 820px; margin: 24px auto; padding: 0 16px; }
    h1,h2 { margin: 16px 0 8px; }
    table { border-collapse: collapse; width: 100%; margin-top: 8px; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; }
    #feedback { font-weight: 600; margin: 8px 0 4px; }
    #interval { color: #666; margin: 0 0 8px; }
    input[type="text"]{ padding: 6px 8px; }
    button{ padding: 6px 10px; cursor:pointer; }
  </style>
</head>
<body>

  <h1>Вход / Регистрация</h1>
  <div id="auth">
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Пароль" />
    <button id="login">Войти</button>
    <button id="register">Регистрация</button>
    <p id="authStatus" style="font-weight:600;"></p>
  </div>
  <p id="loggedIn" style="display:none;">Вы вошли как <span id="userEmail"></span> <button id="logout">Выйти</button></p>
  <hr/>

  <h1>Добавить слово</h1>
  <form id="addForm">
    <input type="text" name="de" placeholder="Немецкое слово" required />
    <input type="text" name="ru" placeholder="Перевод" required />
    <button type="submit">Добавить</button>
  </form>

  <h1>Тренировка</h1>
  <div id="train">
    <p id="question">Нажми «Начать тренировку»</p>
    <input id="answer" placeholder="Перевод" style="display:none;" />
    <p id="feedback"></p>
    <p id="interval"></p>
    <button id="start">Начать тренировку</button>
  </div>

  <hr />

  <h1>Текущие слова</h1>
  <table>
    <thead>
      <tr>
        <th>DE</th><th>RU</th><th>DE→RU</th><th>RU→DE</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
  <p><button id="reset">Сбросить статистику</button></p>

  <script>

    // ---------- auth ----------

    async function safeFetch(url, options = {}) {
      const r = await fetch(url, options);
      if (r.status === 401) {
        // авто-logout
        await fetch('/api/logout');
        document.getElementById('auth').style.display = 'block';
        document.getElementById('loggedIn').style.display = 'none';
        document.getElementById('authStatus').textContent = 'Сессия истекла, войдите снова.';
        document.getElementById('authStatus').style.color = 'red';
        // очистка интерфейса
        document.getElementById('tableBody').innerHTML = '';
        document.getElementById('question').textContent = 'Нажми «Начать тренировку»';
        document.getElementById('interval').textContent = '';
        document.getElementById('feedback').textContent = '';
        words = [];
        current = null;
        clearInterval(pauseTimer);
        throw new Error('401 Unauthorized');
      }
      return r;
    }

    async function apiCall(url, body){
      const r = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      return await r.json();
    }

    document.getElementById('register').onclick = async ()=>{
      const email=emailInput.value.trim(), password=pwInput.value.trim();
      if (!email || !password) {
        const msg = document.getElementById('authStatus');
        msg.textContent = 'Введите email и пароль.';
        msg.style.color = 'red';
        return;
      }
      const d = await apiCall('/api/register',{email,password});
      const msg = document.getElementById('authStatus');
      if(d.status==='ok'){ msg.textContent='Регистрация успешна! Теперь войдите.'; msg.style.color='green'; }
      else{ msg.textContent='Пользователь уже существует.'; msg.style.color='red'; }
    };

    document.getElementById('login').onclick = async ()=>{
      const email=emailInput.value.trim(), password=pwInput.value.trim();
      if (!email || !password) {
        const msg = document.getElementById('authStatus');
        msg.textContent = 'Введите email и пароль.';
        msg.style.color = 'red';
        return;
      }
      const d = await apiCall('/api/login',{email,password});
      const msg = document.getElementById('authStatus');
      if(d.status==='ok'){
        msg.textContent='Вход выполнен'; msg.style.color='green';
        document.getElementById('auth').style.display='none';
        document.getElementById('loggedIn').style.display='block';
        document.getElementById('userEmail').textContent=email;
        updateTable();
        startBtn.textContent = 'Начать тренировку';
        q.textContent = 'Нажми «Начать тренировку»';
        a.style.display = 'none';
        feedback.textContent = '';
        intElem.textContent = '';
      } else { msg.textContent='Неверные данные.'; msg.style.color='red'; }
    };

    document.getElementById('logout').onclick = ()=>{
      fetch('/api/logout');
      document.getElementById('loggedIn').style.display='none';
      document.getElementById('auth').style.display='block';
      document.getElementById('authStatus').textContent='Вы вышли.';
      // очистка интерфейса:
      document.getElementById('tableBody').innerHTML = '';
      document.getElementById('question').textContent = 'Нажми «Начать тренировку»';
      document.getElementById('interval').textContent = '';
      document.getElementById('feedback').textContent = '';
      words = [];
      current = null;
      clearInterval(pauseTimer);
    };
    const emailInput=document.getElementById('email');
    const pwInput=document.getElementById('password');


    // ---------- helpers ----------
    const DEBUG = true;
    const log = (...a) => DEBUG && console.debug('[WORDS]', ...a);
    let mode = 'idle'; // 'ask' | 'check' | 'next'
    let pauseTimer = null;
    let intervalsHours = [];
    fetch('/api/intervals').then(r=>r.json()).then(arr => intervalsHours = arr);

    function humanInterval(i){
      const h = intervalsHours[i] ?? 0;
      const factor = 1;
      const adjH = h * factor;
      if (adjH < 1)  return `${Math.round(adjH*60)} мин`;
      if (adjH < 24) return `${adjH} ч`;
      return `${Math.round(adjH/24)} дн`;
    }

    // ---------- state ----------
    let words = [];
    let current, reverse;

    // ---------- data fetchers ----------
    async function loadWords(){
      const r = await safeFetch('/api/words');
      words = await r.json();
    }

    async function updateTable(){
      const r = await safeFetch('/api/words');
      const data = await r.json();
      words = data; // синхронизируем кэш
      const body = document.getElementById('tableBody');
      body.innerHTML = '';
      data.forEach(w => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${w.de}</td>
          <td>${w.ru}</td>
          <td>${w.interval_de_ru} (${humanInterval(w.interval_de_ru)})</td>
          <td>${w.interval_ru_de} (${humanInterval(w.interval_ru_de)})</td>
        `;
        body.appendChild(row);
      });
    }

    // ---------- add word form ----------
    document.getElementById('addForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const f = e.target;
      const body = { de: f.de.value.trim(), ru: f.ru.value.trim() };
      if (!body.de || !body.ru) return;
      await safeFetch('/api/add_word', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      f.reset();
      await updateTable();
      await loadWords();
      startBtn.textContent = 'Проверить';
      feedback.textContent = '';
      intElem.textContent = '';
      pickWord();
    });

    // ---------- training ----------
    const q = document.getElementById('question');
    const a = document.getElementById('answer');
    const startBtn = document.getElementById('start');
    const feedback = document.getElementById('feedback');
    const intElem = document.getElementById('interval');

    function pickWord(){
      log('pick:start');
      if (pauseTimer){ clearInterval(pauseTimer); pauseTimer = null; }
      startBtn.style.display = "inline";
      const now = new Date();
      const cards = [];
      for (const w of words){
        if (new Date(w.next_de_ru) < now) cards.push({ w, reverse:false }); // DE→RU
        if (new Date(w.next_ru_de) < now) cards.push({ w, reverse:true  }); // RU→DE
      }
      log('pick:cards', cards.length);

      if (!cards.length){
        const nextTimes = words
          .map(w => Math.min(new Date(w.next_de_ru), new Date(w.next_ru_de)))
          .filter(t => t > new Date())
          .sort((a,b)=>a-b);
        const next = nextTimes[0];
        log('pick:pause', { hasNext: !!next, next });
        if (!next){
          q.textContent = "Все слова на паузе. Ожидание новых слов…";
          a.style.display = "none";
          startBtn.style.display = "none";
          return;
        }

        function tick(){
          const diff = next - new Date();
          if (diff <= 0){
            log('tick:zero -> autostart');
            clearInterval(pauseTimer); pauseTimer = null;
            q.textContent = "Время истекло, загружаем слова...";
            startBtn.textContent = 'Следующее слово'; // сброс кнопки
            loadWords().then(()=>controller());
            return;
          }
          const m = Math.floor(diff/60000);
          const s = Math.floor(diff/1000) % 60;
          q.textContent = `Все слова на паузе. Следующее слово через ${m} мин ${s} сек.`;
        }
        tick();
        pauseTimer = setInterval(tick, 1000);

        a.style.display = "none";
        startBtn.style.display = "none";
        return;
      }

      const pick = cards[Math.floor(Math.random()*cards.length)];
      current = pick.w;
      reverse = pick.reverse;
      log('pick:show', { id: current.id, word: current.de, reverse });

      q.textContent = reverse ? `Переведи: ${current.ru}` : `Переведи: ${current.de}`;
      a.style.display = "inline";
      a.value = "";
      a.focus();
    }

    async function processAnswer(){
      const user = a.value.trim().toLowerCase();
      const correct = reverse ? user === current.de.toLowerCase()
                              : user === current.ru.toLowerCase();
      log('answer', { id: current.id, reverse, user, correct });

      feedback.textContent = correct
        ? `✅ Верно: ${reverse ? current.ru : current.de} — ${reverse ? current.de : current.ru}`
        : `❌ Ошибка: ${reverse ? current.ru : current.de} — ${reverse ? current.de : current.ru}`;
      feedback.style.color = correct ? 'green' : 'red';

      startBtn.disabled = true;

      const resp = await safeFetch('/api/result?fast=0', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: current.id, correct, reverse })
      });

      const data = await resp.json();
      const w = data.updated;

      const key = reverse ? 'interval_ru_de' : 'interval_de_ru';
      const h = intervalsHours[w[key]];
      const text = (h < 1) ? `${Math.round(h*60)} минут`
                 : (h < 24) ? `${h} часов`
                 : `${Math.round(h/24)} дней`;
      intElem.textContent = `Следующая встреча этого слова через ${text}.`;

      await updateTable();
      log('answer:updated');

      startBtn.disabled = false;
      startBtn.textContent = 'Следующее слово';
    }

    async function controller(){
      log('controller', { mode, btn: startBtn.textContent, words: words.length });
      if (!words.length) await loadWords();

      if (startBtn.textContent === 'Начать тренировку' || startBtn.textContent === 'Следующее слово'){
        startBtn.textContent = 'Проверить';
        feedback.textContent = '';
        intElem.textContent = '';
        pickWord();
        return;
      }

      if (startBtn.textContent === 'Проверить'){
        await processAnswer();
        return;
      }
    }

    startBtn.addEventListener('click', controller);

    // Enter = клик по кнопке, но только если не ждём сервер
    a.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !startBtn.disabled){
        e.preventDefault();
        controller();
      }
    });

    // ---------- reset ----------
    document.getElementById('reset').addEventListener('click', async ()=>{
      if (!confirm('Сбросить всю статистику?')) return;
      await safeFetch('/api/reset', { method: 'POST' });
      feedback.textContent = '';
      intElem.textContent = '';
      await updateTable();
    });

    // рендер таблицы
    (async () => {
      try {
        const r = await safeFetch('/api/words');
        if (r.ok) {
          // пользователь залогинен — показываем всё
          const d = await r.json();
          words = d;
          document.getElementById('auth').style.display = 'none';
          document.getElementById('loggedIn').style.display = 'block';
          document.getElementById('userEmail').textContent = d[0]?.user_id || '';
          await updateTable();
          controller();
        }
      } catch {
        // не залогинен — показываем только форму
        document.getElementById('auth').style.display = 'block';
        document.getElementById('loggedIn').style.display = 'none';
        document.getElementById('tableBody').innerHTML = '';
      }
    })();

  </script>
</body>
</html>
