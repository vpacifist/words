<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Немецкие слова</title>
</head>
<body>
  <h2>Добавить слово</h2>
  <form id="addForm">
    <input name="de" placeholder="Немецкое слово" required>
    <input name="ru" placeholder="Перевод" required>
    <button type="submit">Добавить</button>
  </form>
  <hr>

  <h1>Список слов</h1>
  <ul id="words"></ul>

  <hr>
  <h2>Тренировка</h2>
  <div id="train">
    <p id="question">Нажми «Начать тренировку»</p>
    <input id="answer" placeholder="Перевод" style="display:none;">
    <p id="feedback" style="font-weight:bold;"></p>
    <p id="interval" style="font-size:0.9em;color:gray;"></p>
    <button id="start">Начать тренировку</button>
  </div>


  <script>
    fetch('/api/words')
      .then(r => r.json())
      .then(data => {
        const list = document.getElementById('words');
        data.forEach(w => {
          const li = document.createElement('li');
          li.textContent = `${w.de} — ${w.ru}`;
          list.appendChild(li);
        });
      });

    document.getElementById("addForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const body = {
        de: form.de.value,
        ru: form.ru.value
      };
      const res = await fetch("/api/add_word", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      alert("Добавлено: " + data.added.de + " — " + data.added.ru);
      form.reset();
    });

    const q = document.getElementById('question');
    const a = document.getElementById('answer');
    const startBtn = document.getElementById('start');
    let words = [];

    async function loadWords() {
      const res = await fetch('/api/words');
      words = await res.json();
    }

    startBtn.onclick = async () => {
      if (!words.length) await loadWords();
      let current, reverse;

      function nextWord() {
        current = words[Math.floor(Math.random() * words.length)];
        reverse = Math.random() < 0.5;
        q.textContent = reverse
          ? `Переведи: ${current.ru}`
          : `Переведи: ${current.de}`;
        a.value = '';
        a.style.display = 'inline';
        a.focus();
      }

      nextWord();
      startBtn.textContent = 'Проверить';

      startBtn.onclick = () => {
        const user = a.value.trim().toLowerCase();
        const correct = reverse
          ? user === current.de.toLowerCase()
          : user === current.ru.toLowerCase();
        const feedback = document.getElementById('feedback');

        feedback.textContent = correct
          ? `✅ Верно: ${reverse ? current.ru : current.de} — ${reverse ? current.de : current.ru}`
          : `❌ Ошибка: ${reverse ? current.ru : current.de} — ${reverse ? current.de : current.ru}`;
        const intElem = document.getElementById('interval');
        const key = reverse ? "interval_ru_de" : "interval_de_ru";
        intElem.textContent = "Текущий интервал: " + current[key];

        feedback.style.color = correct ? "green" : "red";

        fetch("/api/result", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: current.id, correct, reverse })
        })
          .then(r => r.json())
          .then(res => {
            const w = res.updated;
            const key = reverse ? "interval_ru_de" : "interval_de_ru";
            const intervals = [10/60, 1, 12, 24, 72, 168, 336, 720, 2160, 4320, 8760, 17520];
            const hours = intervals[w[key]];
            let text = "";

            if (hours < 1) text = `${Math.round(hours * 60)} минут`;
            else if (hours < 24) text = `${hours} часов`;
            else text = `${Math.round(hours / 24)} дней`;

            intElem.textContent = `Следующая встреча этого слова через ${text}.`;
          });
        nextWord();
      };
    };

    a.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        startBtn.click();
      }
    });

  </script>
</body>
</html>
