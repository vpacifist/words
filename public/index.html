<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Words — тренажёр</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; line-height: 1.4; max-width: 820px; margin: 24px auto; padding: 0 16px; }
    h1,h2 { margin: 16px 0 8px; }
    table { border-collapse: collapse; width: 100%; margin-top: 8px; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; }
    #feedback { font-weight: 600; margin: 8px 0 4px; }
    #interval { color: #666; margin: 0 0 8px; }
    input[type="text"]{ padding: 6px 8px; }
    button{ padding: 6px 10px; cursor:pointer; }
  </style>
</head>
<body>

  <h1>Добавить слово</h1>
  <form id="addForm">
    <input type="text" name="de" placeholder="Немецкое слово" required />
    <input type="text" name="ru" placeholder="Перевод" required />
    <button type="submit">Добавить</button>
  </form>

  <h1>Тренировка</h1>
  <div id="train">
    <p id="question">Нажми «Начать тренировку»</p>
    <input id="answer" placeholder="Перевод" style="display:none;" />
    <p id="feedback"></p>
    <p id="interval"></p>
    <button id="start">Начать тренировку</button>
  </div>

  <hr />

  <h1>Текущие слова</h1>
  <table>
    <thead>
      <tr>
        <th>DE</th><th>RU</th><th>DE→RU</th><th>RU→DE</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
  <p><button id="reset">Сбросить статистику</button></p>

  <script>
    // ---------- helpers ----------
    let intervalsHours = [];
    fetch('/api/intervals').then(r=>r.json()).then(arr => intervalsHours = arr);
    function humanInterval(i){
      const h = intervalsHours[i] ?? 0;
      if (h < 1)  return `${Math.round(h*60)} мин`;
      if (h < 24) return `${h} ч`;
      return `${Math.round(h/24)} дн`;
    }

    // ---------- state ----------
    let words = [];
    let current, reverse;

    // ---------- data fetchers ----------
    async function loadWords(){
      const r = await fetch('/api/words');
      words = await r.json();
    }

    async function updateTable(){
      const r = await fetch('/api/words');
      const data = await r.json();
      words = data; // синхронизируем кэш
      const body = document.getElementById('tableBody');
      body.innerHTML = '';
      data.forEach(w => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${w.de}</td>
          <td>${w.ru}</td>
          <td>${w.interval_de_ru} (${humanInterval(w.interval_de_ru)})</td>
          <td>${w.interval_ru_de} (${humanInterval(w.interval_ru_de)})</td>
        `;
        body.appendChild(row);
      });
    }

    // ---------- add word form ----------
    document.getElementById('addForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const f = e.target;
      const body = { de: f.de.value.trim(), ru: f.ru.value.trim() };
      if (!body.de || !body.ru) return;
      await fetch('/api/add_word', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      f.reset();
      await updateTable();
    });

    // ---------- training ----------
    const q = document.getElementById('question');
    const a = document.getElementById('answer');
    const startBtn = document.getElementById('start');
    const feedback = document.getElementById('feedback');
    const intElem = document.getElementById('interval');

    function pickWord(){
      const now = new Date();
      const cards = [];
      for (const w of words){
        if (new Date(w.next_de_ru) < now) cards.push({ w, reverse:false }); // DE→RU
        if (new Date(w.next_ru_de) < now) cards.push({ w, reverse:true  }); // RU→DE
      }

      if (!cards.length){
        q.textContent = "Все слова на паузе, попробуй позже.";
        a.style.display = "none";
        startBtn.textContent = "Начать тренировку";
        return;
      }

      const pick = cards[Math.floor(Math.random()*cards.length)];
      current = pick.w;
      reverse = pick.reverse;

      q.textContent = reverse ? `Переведи: ${current.ru}` : `Переведи: ${current.de}`;
      a.style.display = "inline";
      a.value = "";
      a.focus();
    }

    async function processAnswer(){
      const user = a.value.trim().toLowerCase();
      const correct = reverse ? user === current.de.toLowerCase()
                              : user === current.ru.toLowerCase();

      feedback.textContent = correct
        ? `✅ Верно: ${reverse ? current.ru : current.de} — ${reverse ? current.de : current.ru}`
        : `❌ Ошибка: ${reverse ? current.ru : current.de} — ${reverse ? current.de : current.ru}`;
      feedback.style.color = correct ? 'green' : 'red';

      startBtn.disabled = true;

      const resp = await fetch('/api/result', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ id: current.id, correct, reverse })
      });
      const data = await resp.json();
      const w = data.updated;

      const key = reverse ? 'interval_ru_de' : 'interval_de_ru';
      const h = intervalsHours[w[key]];
      const text = (h < 1) ? `${Math.round(h*60)} минут`
                 : (h < 24) ? `${h} часов`
                 : `${Math.round(h/24)} дней`;
      intElem.textContent = `Следующая встреча этого слова через ${text}.`;

      await updateTable();

      startBtn.disabled = false;
      startBtn.textContent = 'Следующее слово';
    }

    async function controller(){
      if (!words.length) await loadWords();

      if (startBtn.textContent === 'Начать тренировку' || startBtn.textContent === 'Следующее слово'){
        startBtn.textContent = 'Проверить';
        feedback.textContent = '';
        intElem.textContent = '';
        pickWord();
        return;
      }

      if (startBtn.textContent === 'Проверить'){
        await processAnswer();
        return;
      }
    }

    startBtn.addEventListener('click', controller);

    // Enter = клик по кнопке, но только если не ждём сервер
    a.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !startBtn.disabled){
        e.preventDefault();
        controller();
      }
    });

    // ---------- reset ----------
    document.getElementById('reset').addEventListener('click', async ()=>{
      if (!confirm('Сбросить всю статистику?')) return;
      await fetch('/api/reset', { method: 'POST' });
      feedback.textContent = '';
      intElem.textContent = '';
      await updateTable();
    });

    // первый рендер таблицы/списка
    updateTable();
  </script>
</body>
</html>
